"use strict";(self.webpackChunkprotoconf=self.webpackChunkprotoconf||[]).push([[4458],{4564:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>a,default:()=>u,frontMatter:()=>i,metadata:()=>c,toc:()=>l});var o=n(5893),r=n(3905);const i={sidebar_position:5},a="Protoconf Mutation Service",c={id:"advanced-usage/mutation-service/mutation-service",title:"Protoconf Mutation Service",description:"Protoconf offers an RPC service for programmatically mutating configurations, which is particularly useful for applications that need to adjust configurations dynamically.",source:"@site/docs/advanced-usage/mutation-service/mutation-service.mdx",sourceDirName:"advanced-usage/mutation-service",slug:"/advanced-usage/mutation-service/",permalink:"/docs/0.1.7/advanced-usage/mutation-service/",draft:!1,unlisted:!1,editUrl:"https://github.com/protoconf/protoconf/tree/main/website/protoconf/docs/advanced-usage/mutation-service/mutation-service.mdx",tags:[],version:"current",sidebarPosition:5,frontMatter:{sidebar_position:5},sidebar:"tutorialSidebar",previous:{title:"Generating YAML, JSON and TOML",permalink:"/docs/0.1.7/advanced-usage/output-formats"},next:{title:"Protoconf Mutation CLI",permalink:"/docs/0.1.7/advanced-usage/mutation-service/mutation-cli"}},s={},l=[{value:"Protoconf Mutation Service Definition",id:"protoconf-mutation-service-definition",level:2},{value:"Protoconf Value Definition",id:"protoconf-value-definition",level:2},{value:"Mutation Server",id:"mutation-server",level:2},{value:"Dynamic Dictionary Example",id:"dynamic-dictionary-example",level:2},{value:"Mutation Server Flags",id:"mutation-server-flags",level:2}];function d(e){const t={code:"code",h1:"h1",h2:"h2",p:"p",pre:"pre",...(0,r.ah)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(t.h1,{id:"protoconf-mutation-service",children:"Protoconf Mutation Service"}),"\n",(0,o.jsx)(t.p,{children:"Protoconf offers an RPC service for programmatically mutating configurations, which is particularly useful for applications that need to adjust configurations dynamically."}),"\n",(0,o.jsx)(t.p,{children:"This guide will explain how to use Protoconf's mutation service and provide an example of a dynamic dictionary that can be loaded from other files and iterated over."}),"\n",(0,o.jsx)(t.h2,{id:"protoconf-mutation-service-definition",children:"Protoconf Mutation Service Definition"}),"\n",(0,o.jsx)(t.p,{children:"The Protoconf mutation service is defined as follows:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-protobuf",children:'syntax = "proto3";\npackage v1;\n\noption java_package = "com.protoconf.server.api.v1";\n\nimport "datatypes/proto/v1/protoconf_value.proto";\n\nmessage ConfigMutationRequest {\n  string path = 1;\n  ProtoconfValue value = 2;\n  string script_metadata = 3;\n}\n\nmessage ConfigMutationResponse {}\n\nservice ProtoconfMutationService {\n  rpc MutateConfig(ConfigMutationRequest) returns (ConfigMutationResponse);\n}\n'})}),"\n",(0,o.jsx)(t.h2,{id:"protoconf-value-definition",children:"Protoconf Value Definition"}),"\n",(0,o.jsxs)(t.p,{children:["The ",(0,o.jsx)(t.code,{children:"ProtoconfValue"})," message is defined as follows:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-protobuf",children:"message ProtoconfValue {\n    string proto_file = 1;\n    google.protobuf.Any value = 2;\n    repeated SecretMetadata secrets = 3;\n}\n"})}),"\n",(0,o.jsx)(t.h2,{id:"mutation-server",children:"Mutation Server"}),"\n",(0,o.jsxs)(t.p,{children:["The mutation server writes the content of the ",(0,o.jsx)(t.code,{children:"ProtoconfValue"})," to ",(0,o.jsx)(t.code,{children:"./mutable_configs/<path from ConfigMutationRequest>"}),"."]}),"\n",(0,o.jsx)(t.p,{children:"These files can be loaded into the Starlark files as follows:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-starlark",children:'load("mutable:<path>", "value")\n'})}),"\n",(0,o.jsx)(t.h2,{id:"dynamic-dictionary-example",children:"Dynamic Dictionary Example"}),"\n",(0,o.jsxs)(t.p,{children:["Assume the following template is stored at ",(0,o.jsx)(t.code,{children:"./src/demo/inputs.pinc.template"}),". It will iterate through all the files under ",(0,o.jsx)(t.code,{children:"./mutable_configs/demo/inputs"}),", and the outcome will be written to ",(0,o.jsx)(t.code,{children:"./src/demo/inputs.pinc"})," before compilation:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-starlark",children:'"""\nGenerated from {{ .TemplateFilename }}\n"""\n{{ range .Files -}}\nload(\n    "mutable:{{.MutableName}}",\n    {{.VariableName}}="value",\n)\n{{ end }}\n\ninputs = {\n{{- range .Files }}\n    "{{.MutableName}}": {{.VariableName}},\n{{- end }}\n'})}),"\n",(0,o.jsx)(t.p,{children:"In this example, we made a dynamic dictionary that can be loaded from other files and be iterated over:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-starlark",children:'load("//demo/inputs.pinc", "inputs")\n'})}),"\n",(0,o.jsx)(t.h2,{id:"mutation-server-flags",children:"Mutation Server Flags"}),"\n",(0,o.jsxs)(t.p,{children:["The Protoconf mutation server runs via the ",(0,o.jsx)(t.code,{children:"protoconf serve"})," command, with the following flags:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-shell",children:'Usage: [OPTION]... protoconfRoot\n  -grpc-address string\n        Server gRPC address (default ":4301")\n  -post string\n        Post mutation script\n  -pre string\n        Pre mutation script\n'})}),"\n",(0,o.jsxs)(t.p,{children:["The ",(0,o.jsx)(t.code,{children:"-pre"})," flag receives a path to a script to run before writing any file to the local filesystem. This allows for validating that the local directory is clean and ready to receive the change (for example, ensuring synchronization with the head of your git repository, acquiring a lock, or any other preparatory steps)."]}),"\n",(0,o.jsxs)(t.p,{children:["The ",(0,o.jsx)(t.code,{children:"-post"})," flag receives a path to a script to run after the file is written to the local directory. This script should initiate the protoconf compile -process-templates . command, and then either sync the outcome back to git or run the protoconf insert command to write the outcomes to the key-value store."]}),"\n",(0,o.jsx)(t.p,{children:"With these tools, Protoconf offers a powerful and flexible way to manage dynamic configuration changes in your application, with the ability to customize the process to match your specific needs."})]})}function u(e={}){const{wrapper:t}={...(0,r.ah)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},3905:(e,t,n)=>{n.d(t,{ah:()=>l});var o=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,o,r=function(e,t){if(null==e)return{};var n,o,r={},i=Object.keys(e);for(o=0;o<i.length;o++)n=i[o],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(o=0;o<i.length;o++)n=i[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=o.createContext({}),l=function(e){var t=o.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):a(a({},t),e)),n},d={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},u=o.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,u=c(e,["components","mdxType","originalType","parentName"]),p=l(n),f=r,h=p["".concat(s,".").concat(f)]||p[f]||d[f]||i;return n?o.createElement(h,a(a({ref:t},u),{},{components:n})):o.createElement(h,a({ref:t},u))}));u.displayName="MDXCreateElement"}}]);