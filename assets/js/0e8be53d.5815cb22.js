"use strict";(self.webpackChunkprotoconf=self.webpackChunkprotoconf||[]).push([[2],{4650:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>s,contentTitle:()=>a,default:()=>h,frontMatter:()=>i,metadata:()=>l,toc:()=>c});var o=r(5893),t=r(3905);const i={sidebar_position:1},a="Terraform",l={id:"integrations/terraform",title:"Terraform",description:"Installation and Initialization",source:"@site/docs/integrations/terraform.md",sourceDirName:"integrations",slug:"/integrations/terraform",permalink:"/docs/0.1.7/integrations/terraform",draft:!1,unlisted:!1,editUrl:"https://github.com/protoconf/protoconf/tree/main/website/protoconf/docs/integrations/terraform.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"tutorialSidebar",previous:{title:"Integrations",permalink:"/docs/0.1.7/category/integrations"},next:{title:"Envoy",permalink:"/docs/0.1.7/integrations/envoy"}},s={},c=[{value:"Installation and Initialization",id:"installation-and-initialization",level:2},{value:"Generation",id:"generation",level:2},{value:"Usage",id:"usage",level:2},{value:"Exporting Configurations",id:"exporting-configurations",level:2},{value:"External tools",id:"external-tools",level:3},{value:"Watch for Configs",id:"watch-for-configs",level:3},{value:"Docker Deployment",id:"docker-deployment",level:4}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,t.ah)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.h1,{id:"terraform",children:"Terraform"}),"\n",(0,o.jsx)(n.h2,{id:"installation-and-initialization",children:"Installation and Initialization"}),"\n",(0,o.jsxs)(n.p,{children:["First, install ",(0,o.jsx)(n.code,{children:"protoconf-terraform"})," using Homebrew:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"brew install protoconf/tap/protoconf-terraform\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Alternatively, download it from the ",(0,o.jsx)(n.a,{href:"https://github.com/protoconf/protoconf-terraform",children:"Github repository"}),"."]}),"\n",(0,o.jsx)(n.p,{children:"Next, initialize the workspace:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"protoconf-terraform init\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Create a ",(0,o.jsx)(n.code,{children:"provider.tf"})," file and include the providers you want to use:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:'provider "tls" {}\nprovider "null" {}\nprovider "random" {}\n'})}),"\n",(0,o.jsx)(n.p,{children:"Then, initialize Terraform:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"terraform init\n"})}),"\n",(0,o.jsx)(n.p,{children:"This command downloads all the necessary providers to the local cache."}),"\n",(0,o.jsx)(n.h2,{id:"generation",children:"Generation"}),"\n",(0,o.jsx)(n.p,{children:"Next, generate the provider schemas:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"protoconf-terraform generate\n"})}),"\n",(0,o.jsxs)(n.p,{children:["This command connects to the providers, fetches their schemas, writes the schemas into protobuf files, and updates ",(0,o.jsx)(n.code,{children:"./src/terraform/v1/terraform.proto"})," to link these files."]}),"\n",(0,o.jsx)(n.h2,{id:"usage",children:"Usage"}),"\n",(0,o.jsx)(n.p,{children:"Here's an example of how to use the API:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'load("//terraform/v1/util.pinc", "util")\nload("//terraform/random/provider/v3/random.proto", "Random")\nload("//terraform/random/resources/v3/pet.proto", "RandomPet")\nload("//terraform/null/provider/v3/null.proto", "Null")\nload("//terraform/null/datasources/v3/data.proto", "NullDataSource")\n\ntf = util.Terraform(\n    util.Provider(Random()),\n    util.Resource(\n        "dog",\n        RandomPet(),\n        lambda dog: util.Output(\n            "dog_name", dog.id\n        ),\n    ),\n    util.Data(\n        "null_name",\n        NullDataSource(),\n        lambda data: util.Group(\n            util.Output("null_random", data.random),\n            util.Output("has_computed_default", data.has_computed_default),\n        ),\n    ),\n    util.Module(\n        "ssh_key",\n        source="JamesWoolfenden/key/tls",\n        version="0.0.6",\n        out_dir="/tmp/sshkey",\n        then=lambda output: util.Group(\n            util.Output("public_key", output("public_key")),\n        ),\n    ),\n)\n'})}),"\n",(0,o.jsx)(n.p,{children:"Here's how to interpret the different parts of the example:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"util.Terraform"}),": Initializes a new Terraform configuration."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"util.Provider(Random())"}),': Adds a provider configuration for the "random" provider.']}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"util.Resource"}),': Creates a new resource of type "random_pet" with the identifier "dog".']}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"util.Data"}),': Creates a new data source of type "null_data_source" with the identifier "null_name".']}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"util.Module"}),': Adds a module with the identifier "ssh_key".']}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"exporting-configurations",children:"Exporting Configurations"}),"\n",(0,o.jsxs)(n.p,{children:["After creating the ",(0,o.jsx)(n.code,{children:"tf"})," Terraform object, there are two ways to export the configurations:"]}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsx)(n.li,{children:"Use external tools like Terraform Cloud, Atlantis, env0 or Spacelift"}),"\n",(0,o.jsxs)(n.li,{children:["Use ",(0,o.jsx)(n.code,{children:"protoconf-terraform run"})," to watch for config changes in protoconf and apply them immediatly."]}),"\n"]}),"\n",(0,o.jsx)(n.h3,{id:"external-tools",children:"External tools"}),"\n",(0,o.jsxs)(n.p,{children:["Use the ",(0,o.jsx)(n.code,{children:".tf.json"})," config suffix to create Terraform compatible files under ",(0,o.jsx)(n.code,{children:"./outputs"}),". These files can be used to either run locally on the developer's machine or to be picked up later by the developer's favourite Terraform management tool (recommended for infrastructure provisioning with long provisioning times like VPC, compute, clusters)."]}),"\n",(0,o.jsx)(n.h3,{id:"watch-for-configs",children:"Watch for Configs"}),"\n",(0,o.jsxs)(n.p,{children:["Use ",(0,o.jsx)(n.code,{children:"protoconf-terraform run"}),": This command needs a ",(0,o.jsx)(n.code,{children:"SubscriptionConfig"})," for protoconf-terraform to know which configs to watch."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'load("//protoconf_terraform/config/v1/config.proto", "SubscriptionConfig")\n\ndef main():\n    return SubscriptionConfig(keys=[\n        "example/dog",\n        "example/cat",\n    ])\n'})}),"\n",(0,o.jsx)(n.p,{children:"This approach is recommended for short running provisioning such as Kubernetes resources, DNS updates etc. You can use this approach with the mutation API to create:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"Continuous Deployment pipelines"}),"\n",(0,o.jsx)(n.li,{children:"Ephemeral deployments (for development purposes)"}),"\n",(0,o.jsx)(n.li,{children:"Canaries"}),"\n",(0,o.jsx)(n.li,{children:"Automatic failovers"}),"\n"]}),"\n",(0,o.jsx)(n.h4,{id:"docker-deployment",children:"Docker Deployment"}),"\n",(0,o.jsxs)(n.p,{children:["Running ",(0,o.jsx)(n.code,{children:"protoconf-terraform"})," in a Docker container involves packaging the necessary files and running the container."]}),"\n",(0,o.jsxs)(n.p,{children:["First, you'll need to create a ",(0,o.jsx)(n.code,{children:"Dockerfile"}),". Here's an example ",(0,o.jsx)(n.code,{children:"Dockerfile"})," for ",(0,o.jsx)(n.code,{children:"protoconf-terraform"}),":"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-docker",children:'FROM homebrew/brew AS installer\n\nRUN brew install protoconf/tap/protoconf-terraform hashicorp/tap/terraform\n\nFROM alpine\n# Add Maintainer Info\nLABEL maintainer="Your Name <your.email@example.com>"\n\n# Set the Current Working Directory inside the container\nWORKDIR /app\n\nCOPY --from=installer /home/linuxbrew/.linuxbrew/bin/terraform /usr/local/bin/terraform\nCOPY --from=installer /home/linuxbrew/.linuxbrew/bin/protoconf-terraform /usr/local/bin/protoconf-terraform\n\n# Install git.\n# Git is required for fetching the dependencies.\nRUN apk update && apk add --no-cache git\n\n# Copy proto files\nCOPY ./src/terraform /app/src/terraform\n\n# This container will be executable\nENTRYPOINT ["protoconf-terraform"]\n'})}),"\n",(0,o.jsxs)(n.p,{children:["To build the Docker image, navigate to the directory containing your ",(0,o.jsx)(n.code,{children:"Dockerfile"})," and run:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"docker build -t protoconf-terraform .\n"})}),"\n",(0,o.jsxs)(n.p,{children:["After building the Docker image, you can run the ",(0,o.jsx)(n.code,{children:"protoconf-terraform"})," command within a Docker container using the following command:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-shell",children:"docker run -it --rm protoconf-terraform COMMAND\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Replace ",(0,o.jsx)(n.code,{children:"COMMAND"})," with the command you want to run, such as ",(0,o.jsx)(n.code,{children:"init"}),", ",(0,o.jsx)(n.code,{children:"generate"}),", or ",(0,o.jsx)(n.code,{children:"run"}),"."]}),"\n",(0,o.jsx)(n.p,{children:"Remember that any changes made within the Docker container won't persist after the container is stopped. If you want to persist data across Docker runs, consider using Docker volumes."})]})}function h(e={}){const{wrapper:n}={...(0,t.ah)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},3905:(e,n,r)=>{r.d(n,{ah:()=>c});var o=r(7294);function t(e,n,r){return n in e?Object.defineProperty(e,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[n]=r,e}function i(e,n){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);n&&(o=o.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),r.push.apply(r,o)}return r}function a(e){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?i(Object(r),!0).forEach((function(n){t(e,n,r[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):i(Object(r)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(r,n))}))}return e}function l(e,n){if(null==e)return{};var r,o,t=function(e,n){if(null==e)return{};var r,o,t={},i=Object.keys(e);for(o=0;o<i.length;o++)r=i[o],n.indexOf(r)>=0||(t[r]=e[r]);return t}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(o=0;o<i.length;o++)r=i[o],n.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(t[r]=e[r])}return t}var s=o.createContext({}),c=function(e){var n=o.useContext(s),r=n;return e&&(r="function"==typeof e?e(n):a(a({},n),e)),r},d={inlineCode:"code",wrapper:function(e){var n=e.children;return o.createElement(o.Fragment,{},n)}},h=o.forwardRef((function(e,n){var r=e.components,t=e.mdxType,i=e.originalType,s=e.parentName,h=l(e,["components","mdxType","originalType","parentName"]),p=c(r),u=t,f=p["".concat(s,".").concat(u)]||p[u]||d[u]||i;return r?o.createElement(f,a(a({ref:n},h),{},{components:r})):o.createElement(f,a({ref:n},h))}));h.displayName="MDXCreateElement"}}]);